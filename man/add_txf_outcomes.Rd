% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/add_time_to_event_variables.R
\name{add_txf_outcomes}
\alias{add_txf_outcomes}
\title{Add time-to-event (TTE) follow-up outcomes to a transplant cohort}
\usage{
add_txf_outcomes(df)
}
\arguments{
\item{df}{A data frame representing a transplant cohort (one row per recipient
or transplant). Must include a \code{TRR_ID} column and have an attribute
\code{file_key} (a string) indicating the originating SRTR table key (e.g.,
\code{"KI_txf"}). The companion follow-up key is inferred as the same prefix
with \code{"F"} inserted after the first two characters (e.g., \code{"KI_Ftxf"}).}
}
\value{
The input \code{df} with additional columns:
\describe{
\item{FIRST_FU_MALIG_DATE}{Date of first follow-up malignancy (per TRR).}
\item{FIRST_FU_REJ_DATE_{ORG}}{Date of first acute rejection per organ
(wide columns by organ code).}
}
Existing columns/attributes of \code{df} are preserved.
}
\description{
Uses the cohort's \code{file_key} attribute (as set by your SRTR load helpers)
to locate and load the corresponding follow-up table, then derives:
}
\details{
\itemize{
\item \code{FIRST_FU_MALIG_DATE} — first follow-up malignancy date per \code{TRR_ID}
\item \verb{FIRST_FU_REJ_DATE_\{ORG\}} — first acute rejection date per organ code
(e.g., \code{FIRST_FU_REJ_DATE_KI}, \code{FIRST_FU_REJ_DATE_PA})
}

The function limits the follow-up load to the cohort's \code{TRR_ID}s for
efficiency, and merges the derived dates back into \code{df}.

This helper:
\enumerate{
\item Infers the follow-up table key from \code{attr(df, "file_key")}.
\item Loads the follow-up subset for the cohort's \code{TRR_ID}s via
\code{load_srtr_file()}.
\item Normalizes organ to a two-letter code (\code{ORG_TYPE} := first two
characters of \code{ORG_TY}), selects core follow-up fields, and orders
by \code{TRR_ID} and \code{TFL_PX_STAT_DT}.
\item Computes the earliest malignancy date per \code{TRR_ID} where
\code{TFL_MALIG == "Y"}.
\item Computes the earliest acute rejection date per (\code{TRR_ID}, \code{ORG_TYPE})
where \code{TFL_ACUTE_REJ_EPISODE} indicates at least one treated episode,
and pivots to wide organ-specific columns.
\item Left-joins both results back to \code{df}.
}

\strong{Assumptions/requirements}
\itemize{
\item The follow-up table contains: \code{TRR_ID}, \code{ORG_TY}, \code{TFL_PX_STAT_DT},
\code{TFL_MALIG}, and \code{TFL_ACUTE_REJ_EPISODE}.
\item \code{TFL_PX_STAT_DT} should be a \code{Date}; if stored as \code{YYYYMMDD}, convert
upstream (e.g., \code{as.Date(as.character(x), "\%Y\%m\%d")}).
\item Rejection is identified by the labeled value
\code{"1: Yes, at least one episode treated with anti-rejection agent"}.
Adjust the filter if your coding differs.
}

\strong{Notes}
\itemize{
\item Combined organ codes (e.g., \code{"HL"}) are not split; they will produce a
column \code{FIRST_FU_REJ_DATE_HL}. If you prefer to split into heart/lung,
duplicate those rows before pivoting.
\item This function only derives event \emph{dates}. To build full TTE variables
(censor date, indicator, elapsed time), pass these dates to your
\code{srtr_time_to_event()} helper along with transplant and last-follow-up dates.
}
}
\examples{
\dontrun{
# df loaded earlier, e.g., df <- load_srtr_file("KI_txf")
attr(df, "file_key")
#> "KI_txf"

df2 <- add_txf_outcomes(df)
names(df2)
# ... includes FIRST_FU_MALIG_DATE, FIRST_FU_REJ_DATE_KI, etc.

# Then compute time-to-event from transplant date:
df2 <- srtr_time_to_event(
  df2,
  event_date  = FIRST_FU_MALIG_DATE,
  start_date  = REC_TX_DT,
  censor_date = TFL_LAFUDATEKI,
  prefix      = "REC_MALIG"
)
}

}
\seealso{
\code{\link{srtr_time_to_event}}, \code{\link{load_srtr_file}}
}
